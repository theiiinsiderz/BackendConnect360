// =======================
// PRISMA GENERATOR
// =======================
generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// =======================
// DATABASE
// =======================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================

enum UserRole {
  USER
  ADMIN
}

enum DomainType {
  CAR
  BIKE
  PET
  KID
}

enum TagStatus {
  MINTED
  UNCLAIMED
  ACTIVE
  SUSPENDED
  REVOKED
}

// =======================
// COMPANY (SPONSORED CLIENT)
// =======================

model Company {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?
  qrDesignUrl  String?
  contactEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tags Tag[]

  @@index([createdAt])
}

// =======================
// USER
// Auto created when QR claimed
// =======================

model User {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  name        String?
  email       String?
  avatar      String?

  role UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tags        Tag[]
  deviceToken DeviceToken?
}

// =======================
// TAG (QR CODE)
// Generated by ADMIN
// =======================

model Tag {
  id   String @id @default(uuid())
  code String @unique // QR unique code

  // Sponsored Company
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Owner
  userId String?
  user   User? @relation(fields: [userId], references: [id])

  nickname String?

  domainType DomainType
  status     TagStatus  @default(MINTED)

  // Privacy Controls
  allowMaskedCall      Boolean @default(false)
  allowWhatsapp        Boolean @default(false)
  allowSms             Boolean @default(false)
  showEmergencyContact Boolean @default(false)

  // Domain Profiles
  carProfile  CarProfile?
  bikeProfile BikeProfile?
  kidProfile  KidProfile?
  petProfile  PetProfile?

  scans Scan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([status, createdAt(sort: Desc)])
  @@index([companyId, status, createdAt(sort: Desc)])
  @@index([domainType, status, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
}

// =======================
// DOMAIN MODELS
// =======================

model CarProfile {
  id    String @id @default(uuid())
  tagId String @unique
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  vehicleNumber      String
  vehicleType        String?
  emergencyContacts  Json?
  allowPoliceDispatch Boolean @default(false)
}

model BikeProfile {
  id    String @id @default(uuid())
  tagId String @unique
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  vehicleNumber String
  bikeModel     String?
}

model KidProfile {
  id    String @id @default(uuid())
  tagId String @unique
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  displayName          String
  primaryGuardian      Json
  medicalAlerts        String?
  requireLocationShare Boolean @default(true)
}

model PetProfile {
  id    String @id @default(uuid())
  tagId String @unique
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  petName      String
  breedInfo    String?
  vetContact   Json?
  ownerContact Json
}

// =======================
// SCAN HISTORY
// =======================

model Scan {
  id        String   @id @default(uuid())
  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id])

  location  String?
  ipAddress String?

  timestamp DateTime @default(now())

  @@index([tagId])
}

// =======================
// STORE PRODUCTS (BUY NEW TAGS)
// =======================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String
  price       Float
  imageUrl    String
  category    String
  stock       Int      @default(0)
  isActive    Boolean  @default(true)

  features String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// =======================
// PUSH NOTIFICATIONS
// =======================

model DeviceToken {
  ownerId   String   @id
  user      User     @relation(fields: [ownerId], references: [id])

  pushToken String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =======================
// MASKED MESSAGE / CONTACT
// =======================

model Message {
  id        String   @id @default(uuid())
  dropToken String   @db.VarChar(128)
  content   String   @db.VarChar(300)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([dropToken])
  @@index([createdAt(sort: Desc)])
  @@index([expiresAt])
  @@index([dropToken, expiresAt(sort: Desc)])
  @@index([dropToken, createdAt(sort: Desc)])
}
